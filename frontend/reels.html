<h2 class="text-2xl font-bold text-gray-900 mb-6">ðŸŽ¥ Reels</h2>
<div id="upload-root" class="mb-8"></div>
<div id="reels-root" class="reels-container"></div>

<script type="text/babel">
  const { useState, useEffect, useRef } = React;

  const ReelsApp = () => {
    const [currentIndex, setCurrentIndex] = useState(0);
    const [isPlaying, setIsPlaying] = useState(true);
    const [isMuted, setIsMuted] = useState(false);
    const [videos, setVideos] = useState([]);
    const videoRefs = useRef([]);

    useEffect(() => {
      fetch("http://localhost:3000/api/reels")
        .then((res) => res.json())
        .then((data) => setVideos(data))
        .catch((err) => console.error(err));
    }, []);

    const togglePlay = (index) => {
      const video = videoRefs.current[index];
      if (video) {
        if (isPlaying) video.pause();
        else video.play();
        setIsPlaying(!isPlaying);
      }
    };

    const toggleMute = () => {
      videoRefs.current.forEach((video) => {
        if (video) video.muted = !isMuted;
      });
      setIsMuted(!isMuted);
    };

    const handleSwipe = (direction) => {
      if (direction === "up" && currentIndex < videos.length - 1) {
        videoRefs.current[currentIndex].pause();
        setCurrentIndex(currentIndex + 1);
        setIsPlaying(true);
      } else if (direction === "down" && currentIndex > 0) {
        videoRefs.current[currentIndex].pause();
        setCurrentIndex(currentIndex - 1);
        setIsPlaying(true);
      }
    };

    useEffect(() => {
      let touchStartY = 0;
      const handleTouchStart = (e) => {
        touchStartY = e.touches[0].clientY;
      };
      const handleTouchEnd = (e) => {
        const touchEndY = e.changedTouches[0].clientY;
        const deltaY = touchEndY - touchStartY;
        if (deltaY > 50) handleSwipe("down");
        if (deltaY < -50) handleSwipe("up");
      };
      const container = document.getElementById("reels-root");
      container.addEventListener("touchstart", handleTouchStart);
      container.addEventListener("touchend", handleTouchEnd);
      return () => {
        container.removeEventListener("touchstart", handleTouchStart);
        container.removeEventListener("touchend", handleTouchEnd);
      };
    }, [currentIndex]);

    useEffect(() => {
      videoRefs.current.forEach((video, index) => {
        if (video) {
          video.muted = isMuted;
          if (index === currentIndex) video.play().catch(() => {});
          else {
            video.pause();
            video.currentTime = 0;
          }
        }
      });
    }, [currentIndex, isMuted]);

    return (
      <div className="relative w-full h-full">
        {videos.map((video, index) => (
          <div
            key={video.id}
            className="video-wrapper"
            style={{
              transform: `translateY(${(index - currentIndex) * 100}%)`,
            }}
          >
            <video
              ref={(el) => (videoRefs.current[index] = el)}
              className="video-player"
              src={`http://localhost:3000${video.videoUrl}`}
              loop
              playsInline
              onClick={() => togglePlay(index)}
            />
            <div className="video-overlay">
              <div className="flex items-center mb-2">
                <img
                  src="https://randomuser.me/api/portraits/women/44.jpg"
                  alt={video.username}
                  className="w-8 h-8 rounded-full mr-2"
                />
                <span className="font-medium">{video.username}</span>
              </div>
              <p className="text-sm">{video.description}</p>
            </div>
            <div className="video-controls">
              <div></div>
              <div className="side-buttons">
                <div className="side-button">
                  <i className="far fa-heart"></i>
                  <span>{video.likes}</span>
                </div>
                <div className="side-button">
                  <i className="far fa-comment"></i>
                  <span>{video.comments}</span>
                </div>
                <div className="side-button">
                  <i className="fas fa-share"></i>
                  <span>Share</span>
                </div>
                <div className="control-button" onClick={toggleMute}>
                  <i
                    className={
                      isMuted ? "fas fa-volume-mute" : "fas fa-volume-up"
                    }
                  ></i>
                </div>
              </div>
            </div>
            <div className="absolute top-2 right-2 bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded-full">
              {video.duration}
            </div>
          </div>
        ))}
      </div>
    );
  };

  const UploadForm = () => {
    const [file, setFile] = useState(null);
    const [description, setDescription] = useState("");
    const [duration, setDuration] = useState("");

    const handleSubmit = (e) => {
      e.preventDefault();
      const formData = new FormData();
      formData.append("video", file);
      formData.append("description", description);
      formData.append("duration", duration);

      fetch("http://localhost:3000/api/reels", {
        method: "POST",
        headers: { Authorization: `Bearer ${localStorage.getItem("token")}` },
        body: formData,
      })
        .then((res) => res.json())
        .then((data) => alert("Video uploaded!"))
        .catch((err) => console.error(err));
    };

    return (
      <form
        onSubmit={handleSubmit}
        className="max-w-md mx-auto bg-white p-6 rounded-xl shadow-md"
      >
        <div className="mb-4">
          <label className="block text-gray-700">Video File</label>
          <input
            type="file"
            accept="video/*"
            onChange={(e) => setFile(e.target.files[0])}
            className="w-full p-2 border rounded"
            required
          />
        </div>
        <div className="mb-4">
          <label className="block text-gray-700">Description</label>
          <input
            type="text"
            value={description}
            onChange={(e) => setDescription(e.target.value)}
            className="w-full p-2 border rounded"
            required
          />
        </div>
        <div className="mb-4">
          <label className="block text-gray-700">Duration (e.g., 0:45)</label>
          <input
            type="text"
            value={duration}
            onChange={(e) => setDuration(e.target.value)}
            className="w-full p-2 border rounded"
            required
          />
        </div>
        <button
          type="submit"
          className="w-full py-2 bg-gradient-to-r from-pink-500 to-orange-500 text-white rounded"
        >
          Upload Reel
        </button>
      </form>
    );
  };

  ReactDOM.render(<UploadForm />, document.getElementById("upload-root"));
  ReactDOM.render(<ReelsApp />, document.getElementById("reels-root"));
</script>
